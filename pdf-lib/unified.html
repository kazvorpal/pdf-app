<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Proof of Concept</title>
        <style type="text/css">
            body {
              width: 100vw;
              height: 100vh;
              display: flex;
              justify-content: center;
              align-items: center;
              flex-direction: column;
            }

            p {
              font-family: helvetica;
              font-size: 24px;
              text-align: center;
              margin: 25px;
            }

            .small {
              font-family: helvetica;
              font-size: 18px;
              text-align: center;
              margin: 25px;
            }

            button {
              background-color: #008CBA;
              border: none;
              color: white;
              padding: 15px 32px;
              text-align: center;
              font-size: 16px;
            }
        </style>
        <script src="pdf-lib.min.js"></script>
    </head>
    <body>
        <!-- <canvas id="imageconvertor" width="200" height="200"></canvas> --><p>
        <input type="file" name="" id="filezero" onchange="processfile(event)"></p>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.0.272/jspdf.debug.js"></script>
        <script type="text/javascript">
        </script>
        <!-- <script src="https://unpkg.com/pdf-lib"></script> -->
<!--         <script src="https://unpkg.com/pdf-lib@1.4.0"></script>
        <script src="https://unpkg.com/downloadjs@1.4.7"></script>
 -->        <p>Click the button to embed PDF pages with <code>pdf-lib</code></p>
        <button onclick="createPdf('display')">View PDF</button>
        <br/>
        <button onclick="createPdf('save')">Download PDF</button>
        <p class="small">(Your browser will download the resulting file)</p>
        <iframe id="pdf" style="width: 100%; height: 100%;"></iframe>
    </body>
        <script type="text/javascript">
            const { PDFDocument } = PDFLib;
            
            // createPdf();

            var filist = [];
            var files = [];
            var sizelimit = 1000000;
            var types = ["image/png", "image/jpeg", "image/gif", "application/pdf"];

            const processfile = (event) => {
                if (event.target.files[0].size < sizelimit||true) {
                    console.log(event.target.files[0].size + " is smaller than " + sizelimit);
                    if (types.includes(event.target.files[0].type)) {
                        console.log("contains legit type");
                        files.push(event.target.files[0]);
                        files[files.length-1].url = (URL.createObjectURL(event.target.files[0]));
                        // filist.push(URL.createObjectURL(event.target.files[0]));
                        console.log(files);
                        // console.log(filist);
                    } else {
                        alert("contains bogus file type");
                        console.log(event.target.files[0]);
                    }
                } else {
                    console.log(event.target.files[0].size + " is smaller than " + sizelimit);
                    alert("Sorry, that's too big! The allowed file size is " + sizelimit)
                }
            }
            const typify = (type) => {
                    ty = type.substr(type.indexOf("/")+1)
                    pe = (ty=="jpeg") ? "jpg" : ty;
                    tpe = pe.charAt(0).toUpperCase() + pe.slice(1)
                    return (tpe);
            }

            const createPdf = async (context = 'display') => {
                pdfDoc = await PDFDocument.create();
                for (file of files) {
                    bytes = await fetch(file.url).then((res) => res.arrayBuffer())
                    console.log(file);
                    tipe = typify(file.type);
                    if (tipe == "Pdf") {
                        fullpdf = await PDFDocument.load(bytes, {ignoreEncryption: true})
                        for(count = 0; count < fullpdf.getPages().length; count++) {
                            page = pdfDoc.addPage();
                            thepdf = await pdfDoc.embedPage(fullpdf.getPages()[count]);
                            page.drawPage(thepdf, {
                                width: page.getWidth(),
                                height: page.getHeight()
                            });
                        }
                    } else {
                        page = pdfDoc.addPage();
                        const image = await pdfDoc["embed" + tipe](bytes);
                        // const dims = image.scale(0.5)
                        page.drawImage(image, {
                        })
                        page.moveTo(55, 100);
                    }
                }


                if (context == "save") {
                    const pdfBytes = await pdfDoc.save();
                    // Trigger the browser to download the PDF document
                    download(pdfBytes, "pdf-lib_pdf_page_embedding_example.pdf", "application/pdf");
                } else {
                    const pdfDataUri = await pdfDoc.saveAsBase64({ dataUri: true });
                    document.getElementById('pdf').src = pdfDataUri;
                }
            }
        </script>
</html>